<!DOCTYPE html>
<html lang="en">

  <head>

	<% include ../partials/head %>

  </head>

  <body>

    <!-- Navigation -->
    
	<% include ../partials/nav %>

    <!-- Page Content -->
<section>
<div class="container" id="auth">
<h1 id="sectionHeader" class="section-heading pb-4" style="text-align:center;">Log on</h1>

<form method="POST" id="form" enctype="multipart/form-data" action="/auth">
<% if (locals.csrfToken) { %>
	<input type="hidden" name="_csrf" value="<%= csrfToken %>">
<% } %>
<div class="row form-group">
<div class="col-lg-2">
</div>
<div class="col-lg-8">
  <label for="e1" class="text-uppercase">Email</label>
	<% if (locals.email && email !== 'undefined') { %>
		<input class="form-control" type="email" name="email" id="e1" value="<%= locals.email %>" @blur="confirmEmail"/>
	<% } else { %>
		<input class="form-control" type="email" name="email" id="e1" @blur="confirmEmail"/>
	<% } %>

	<div class="col-lg-8" :class="(!isUser ? 'alert-danger' : 'alert-success')" role="alert" v-text="message" style="text-align:center;margin:15px;"></div>
</div>
</div>
<div class="row form-group">
	<div class="col-lg-2">
	</div>
	<div class="col-lg-4" v-if="isUser">
	<label for="u1" class="text-uppercase">Username</label>
	<% if (locals.username && username !== 'undefined') { %>
		<input class="form-control" type="text" name="username" id="u1" value="<%= locals.username %>"/>
	<% } else { %>
		<input class="form-control" type="text" name="username" id="u1"/>
	<% } %>

	</div>
	<div class="col-lg-4" v-if="isUser">
	<label for="p1" class="text-uppercase">Password</label>
	<input class="form-control" type="password" name="password" id="p1" @blur="validatePassword"/>
	
	<div id="confirmPassword" v-if="pw">
	<label for="p2" class="text-uppercase">Confirm Password</label>
	<input class="form-control" type="password" name="confirm_password" id="p2" @keyup="confirmPassword"/>
	</div>

	</div>
<div class="col-lg-2">
</div>
</div>

<div class="row">
<div class="col-lg-2"></div>
<div class="col-lg-8">&nbsp;</div>
<div class="col-lg-2"></div>
</div> 

<div class="row form-group">
<div class="col-lg-2">
</div>
<div class="col-lg-4">

       
</div>
<div class="col-lg-4">
	
	 <input id="submitButton" class="btn btn-primary btn-block" type="submit"  :disabled="!confirmed"/>
	 
</div>
<div class="col-lg-2">
</div>
</div>
 
 </form>
 <h6>You may also authenticate using your SLDSA Slack account:</h6>
 <a href="/auth/slack" ariaDescription="Authenticate with Slack" style="display:inline-block;height:auto;">
 	<img src="https://api.slack.com/img/sign_in_with_slack.png"></img>
 </a>

 </div>
 
</section>
 
 
 	<% include ../partials/socialmedia %>
			
		</div>
		<!-- /.container -->
	<% include ../partials/footer %>
	<script>
	new Vue({ 
		el: '#auth',
		data() {
			return { 
				isUser: this.parseObj(
					<%- isUser %>
				),
				pw: false,
				lc: false,
				uc: false,
				nu: false,
				confirmed: false,
				message: ''
			}
		},
		beforeDestroy(){
		},
		mounted(){
			var self = this;
		},
		methods: {
			parseObj(obj) {
				if (!obj) return '';
				return obj;
			},
			confirmEmail(e) {
				var self = this;
				var val = e.target.value.trim();
				if (val !== '') {
					var email = encodeURIComponent(val);
					$.post('/checkauth/'+email).then((response)=>{
						console.log(response)
						if (!response) {
							self.isUser = response;
							self.message = 'You need to have your e-mail address added to the guest list. Alternatively, core members may login with Slack.'
						} else if (response === true) {
							self.isUser = true;
							self.message = 'You are on the guest list.'
						} else if (!response.slack) {
							return window.location.href = '/login?u='+encodeURIComponent(response.username);
						} else {
							return window.location.href = '/auth?u='+encodeURIComponent(response.username)+'&e='+encodeURIComponent(response.email);
						}
					})
					.catch((err)=>{
						self.isUser = false;
						self.message = 'There was an error looking up that e-mail address. Please try again.'
					})
				}
			},
			validatePassword(e){
				var self = this;
				var val = e.target.value;
				self.lc = /[a-z]/g.test(val);
				self.uc = /[A-Z]/g.test(val);
				self.nu = /\d/g.test(val);
				if (self.lc && self.uc && self.nu) {
					self.pw = true;
					setTimeout(function(){
						$('#p2').focus();
					}, 500)
				} else {
					self.pw = false;
					self.message = 'Your password must contain at least one lowercase, one uppercase letter, and at least one number.'
				}
				
			},
			confirmPassword(e) {
				var self = this;
				var val = e.target.value;
				self.confirmed = ($('#p1').val() === val) 
			},
		}
	})
	</script>
	</body>

</html>